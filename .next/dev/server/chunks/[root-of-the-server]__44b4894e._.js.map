{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/khaled/Downloads/vin/GlobalVin-master/src/lib/db/connect.ts"],"sourcesContent":["import mongoose from \"mongoose\";\n\nconst MONGODB_URI = process.env.MONGODB_URI!;\n\nif (!MONGODB_URI) {\n  throw new Error(\"Please define the MONGODB_URI environment variable inside .env.local\");\n}\n\ninterface MongooseCache {\n  conn: typeof mongoose | null;\n  promise: Promise<typeof mongoose> | null;\n}\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var mongoose: MongooseCache | undefined;\n}\n\nlet cached: MongooseCache = global.mongoose || { conn: null, promise: null };\n\nif (!global.mongoose) {\n  global.mongoose = cached;\n}\n\nasync function connectDB(): Promise<typeof mongoose> {\n  if (cached.conn) {\n    return cached.conn;\n  }\n\n  if (!cached.promise) {\n    const opts = {\n      bufferCommands: false,\n    };\n\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {\n      console.log(\"âœ… MongoDB connected successfully\");\n      return mongoose;\n    });\n  }\n\n  try {\n    cached.conn = await cached.promise;\n  } catch (e) {\n    cached.promise = null;\n    throw e;\n  }\n\n  return cached.conn;\n}\n\nexport default connectDB;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MAAM;AAClB;AAYA,IAAI,SAAwB,OAAO,QAAQ,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAE3E,IAAI,CAAC,OAAO,QAAQ,EAAE;IACpB,OAAO,QAAQ,GAAG;AACpB;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE;QACf,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,OAAO;YACX,gBAAgB;QAClB;QAEA,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;YACzD,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT;IACF;IAEA,IAAI;QACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IACpC,EAAE,OAAO,GAAG;QACV,OAAO,OAAO,GAAG;QACjB,MAAM;IACR;IAEA,OAAO,OAAO,IAAI;AACpB;uCAEe","debugId":null}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/khaled/Downloads/vin/GlobalVin-master/src/lib/db/models/Lead.ts"],"sourcesContent":["import mongoose, { Schema, Document, Model } from \"mongoose\";\n\n// Lead source types\nexport const LeadSourceValues = {\n  CARFAX: \"carfax\",\n  AUTOCHECK: \"autocheck\",\n  CHINESE_API: \"chinese-api\",\n  CONTACT: \"contact\",\n} as const;\n\nexport type LeadSource = (typeof LeadSourceValues)[keyof typeof LeadSourceValues];\n\n// Lead document interface\nexport interface ILead extends Document {\n  _id: mongoose.Types.ObjectId;\n  name: string;\n  email: string;\n  phone: string;\n  company: string;\n  message: string;\n  source: LeadSource;\n  status: \"new\" | \"contacted\" | \"qualified\" | \"converted\" | \"lost\";\n  ipAddress?: string;\n  userAgent?: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\n// Lead schema\nconst leadSchema = new Schema<ILead>(\n  {\n    name: {\n      type: String,\n      required: [true, \"Name is required\"],\n      trim: true,\n      minlength: [2, \"Name must be at least 2 characters\"],\n      maxlength: [100, \"Name cannot exceed 100 characters\"],\n    },\n    email: {\n      type: String,\n      required: [true, \"Email is required\"],\n      lowercase: true,\n      trim: true,\n      match: [/^\\S+@\\S+\\.\\S+$/, \"Please provide a valid email\"],\n    },\n    phone: {\n      type: String,\n      required: [true, \"Phone is required\"],\n      trim: true,\n    },\n    company: {\n      type: String,\n      trim: true,\n      default: \"\",\n    },\n    message: {\n      type: String,\n      trim: true,\n      default: \"\",\n    },\n    source: {\n      type: String,\n      enum: Object.values(LeadSourceValues),\n      required: [true, \"Source is required\"],\n    },\n    status: {\n      type: String,\n      enum: [\"new\", \"contacted\", \"qualified\", \"converted\", \"lost\"],\n      default: \"new\",\n    },\n    ipAddress: {\n      type: String,\n      default: null,\n    },\n    userAgent: {\n      type: String,\n      default: null,\n    },\n  },\n  {\n    timestamps: true,\n  }\n);\n\n// Add indexes for common queries\nleadSchema.index({ source: 1 });\nleadSchema.index({ status: 1 });\nleadSchema.index({ createdAt: -1 });\nleadSchema.index({ email: 1 });\n\n// Transform output\nleadSchema.set(\"toJSON\", {\n  transform: (_doc: unknown, ret: Record<string, unknown>) => {\n    ret.id = String(ret._id);\n    delete ret._id;\n    delete ret.__v;\n    return ret;\n  },\n});\n\n// Prevent model recompilation in development\nconst Lead: Model<ILead> =\n  mongoose.models.Lead || mongoose.model<ILead>(\"Lead\", leadSchema);\n\nexport default Lead;\n"],"names":[],"mappings":";;;;;;AAAA;;AAGO,MAAM,mBAAmB;IAC9B,QAAQ;IACR,WAAW;IACX,aAAa;IACb,SAAS;AACX;AAoBA,cAAc;AACd,MAAM,aAAa,IAAI,mHAAM,CAC3B;IACE,MAAM;QACJ,MAAM;QACN,UAAU;YAAC;YAAM;SAAmB;QACpC,MAAM;QACN,WAAW;YAAC;YAAG;SAAqC;QACpD,WAAW;YAAC;YAAK;SAAoC;IACvD;IACA,OAAO;QACL,MAAM;QACN,UAAU;YAAC;YAAM;SAAoB;QACrC,WAAW;QACX,MAAM;QACN,OAAO;YAAC;YAAkB;SAA+B;IAC3D;IACA,OAAO;QACL,MAAM;QACN,UAAU;YAAC;YAAM;SAAoB;QACrC,MAAM;IACR;IACA,SAAS;QACP,MAAM;QACN,MAAM;QACN,SAAS;IACX;IACA,SAAS;QACP,MAAM;QACN,MAAM;QACN,SAAS;IACX;IACA,QAAQ;QACN,MAAM;QACN,MAAM,OAAO,MAAM,CAAC;QACpB,UAAU;YAAC;YAAM;SAAqB;IACxC;IACA,QAAQ;QACN,MAAM;QACN,MAAM;YAAC;YAAO;YAAa;YAAa;YAAa;SAAO;QAC5D,SAAS;IACX;IACA,WAAW;QACT,MAAM;QACN,SAAS;IACX;IACA,WAAW;QACT,MAAM;QACN,SAAS;IACX;AACF,GACA;IACE,YAAY;AACd;AAGF,iCAAiC;AACjC,WAAW,KAAK,CAAC;IAAE,QAAQ;AAAE;AAC7B,WAAW,KAAK,CAAC;IAAE,QAAQ;AAAE;AAC7B,WAAW,KAAK,CAAC;IAAE,WAAW,CAAC;AAAE;AACjC,WAAW,KAAK,CAAC;IAAE,OAAO;AAAE;AAE5B,mBAAmB;AACnB,WAAW,GAAG,CAAC,UAAU;IACvB,WAAW,CAAC,MAAe;QACzB,IAAI,EAAE,GAAG,OAAO,IAAI,GAAG;QACvB,OAAO,IAAI,GAAG;QACd,OAAO,IAAI,GAAG;QACd,OAAO;IACT;AACF;AAEA,6CAA6C;AAC7C,MAAM,OACJ,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAQ,QAAQ;uCAEzC","debugId":null}},
    {"offset": {"line": 241, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/khaled/Downloads/vin/GlobalVin-master/src/app/api/leads/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport connectDB from \"@/lib/db/connect\";\nimport Lead from \"@/lib/db/models/Lead\";\nimport jwt from \"jsonwebtoken\";\n\nconst JWT_SECRET = process.env.JWT_SECRET || \"globalvin-jwt-secret-key-2024-very-secure-random-string\";\n\n// POST - Create a new lead (PUBLIC - no auth required)\nexport async function POST(request: NextRequest) {\n  try {\n    await connectDB();\n\n    const body = await request.json();\n    const { name, email, phone, company, message, source } = body;\n\n    // Validation\n    if (!name || !email || !phone || !source) {\n      return NextResponse.json(\n        { message: \"Name, email, phone and source are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Capture additional metadata\n    const ipAddress =\n      request.headers.get(\"x-forwarded-for\") ||\n      request.headers.get(\"x-real-ip\") ||\n      \"unknown\";\n    const userAgent = request.headers.get(\"user-agent\") || \"unknown\";\n\n    // Create new lead\n    const lead = await Lead.create({\n      name,\n      email: email.toLowerCase(),\n      phone,\n      company: company || \"\",\n      message: message || \"\",\n      source,\n      status: \"new\",\n      ipAddress,\n      userAgent,\n    });\n\n    return NextResponse.json(\n      {\n        message: \"Lead submitted successfully\",\n        data: { lead: lead.toJSON() },\n      },\n      { status: 201 }\n    );\n  } catch (error) {\n    console.error(\"Lead submission error:\", error);\n\n    if (error instanceof Error && error.name === \"ValidationError\") {\n      return NextResponse.json({ message: error.message }, { status: 400 });\n    }\n\n    return NextResponse.json(\n      { message: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n\n// GET - Get all leads (PROTECTED - super_admin only)\nexport async function GET(request: NextRequest) {\n  try {\n    // Verify authentication\n    const authHeader = request.headers.get(\"authorization\");\n    const cookieToken = request.cookies.get(\"authToken\")?.value;\n    const token = authHeader?.replace(\"Bearer \", \"\") || cookieToken;\n\n    if (!token) {\n      return NextResponse.json(\n        { message: \"Authorization required\" },\n        { status: 401 }\n      );\n    }\n\n    let decoded: { userId: string; role: string };\n\n    try {\n      decoded = jwt.verify(token, JWT_SECRET) as { userId: string; role: string };\n    } catch {\n      return NextResponse.json(\n        { message: \"Invalid or expired token\" },\n        { status: 401 }\n      );\n    }\n\n    // Check if user is super_admin\n    if (decoded.role !== \"super_admin\") {\n      return NextResponse.json(\n        { message: \"Access denied. Super admin only.\" },\n        { status: 403 }\n      );\n    }\n\n    await connectDB();\n\n    // Parse query parameters\n    const { searchParams } = new URL(request.url);\n    const source = searchParams.get(\"source\");\n    const status = searchParams.get(\"status\");\n    const page = parseInt(searchParams.get(\"page\") || \"1\");\n    const limit = parseInt(searchParams.get(\"limit\") || \"100\");\n\n    // Build query\n    const query: Record<string, string> = {};\n    if (source && source !== \"all\") query.source = source;\n    if (status && status !== \"all\") query.status = status;\n\n    // Fetch leads with pagination\n    const skip = (page - 1) * limit;\n    const [leads, total] = await Promise.all([\n      Lead.find(query).sort({ createdAt: -1 }).skip(skip).limit(limit),\n      Lead.countDocuments(query),\n    ]);\n\n    // Get counts by source\n    const [carfaxCount, autocheckCount, chineseApiCount, contactCount] =\n      await Promise.all([\n        Lead.countDocuments({ source: \"carfax\" }),\n        Lead.countDocuments({ source: \"autocheck\" }),\n        Lead.countDocuments({ source: \"chinese-api\" }),\n        Lead.countDocuments({ source: \"contact\" }),\n      ]);\n\n    return NextResponse.json({\n      data: {\n        leads: leads.map((l) => l.toJSON()),\n        pagination: {\n          page,\n          limit,\n          total,\n          totalPages: Math.ceil(total / limit),\n        },\n        stats: {\n          total,\n          carfax: carfaxCount,\n          autocheck: autocheckCount,\n          chineseApi: chineseApiCount,\n          contact: contactCount,\n        },\n      },\n    });\n  } catch (error) {\n    console.error(\"Leads fetch error:\", error);\n    return NextResponse.json(\n      { message: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}